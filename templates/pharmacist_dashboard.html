{% extends "base.html" %}

{% block title %}Pharmacist Dashboard - RxPress{% endblock %}

{% block content %}
<div class="row">
    <!-- Pending Prescriptions -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pending Prescriptions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Medicines</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prescription in pending_prescriptions %}
                            <tr>
                                <td>{{ prescription.patient_name }}</td>
                                <td><small>{{ prescription.doctor_name }}</small></td>
                                <td>
                                    <small>{{ prescription.medicines[:30] if prescription.medicines else 'No medicines' }}{% if prescription.medicines and prescription.medicines|length > 30 %}...{% endif %}</small>
                                </td>
                                <td><small>{{ prescription.created_date.strftime('%d/%m') if prescription.created_date else 'N/A' }}</small></td>
                                <td>
                                    <a href="{{ url_for('dispense_prescription', prescription_id=prescription.id) }}"
                                       class="btn btn-success btn-sm" onclick="return confirm('Mark this prescription as dispensed?')">
                                        <i class="fas fa-check"></i> Dispense
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not pending_prescriptions %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No pending prescriptions</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Management -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Stock Management</h5>
            </div>
            <div class="card-body">
                <!-- Add/Update Stock Form -->
                <form method="POST" action="{{ url_for('update_stock') }}" class="mb-3">
                    <div class="row g-2">
                        <div class="col-5">
                            <select class="form-select form-select-sm" name="medicine_id" required>
                                <option value="">Select Medicine</option>
                                {% for medicine in medicines %}
                                <option value="{{ medicine.id }}">{{ medicine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control form-control-sm" name="quantity"
                                   placeholder="Qty" min="1" required>
                        </div>
                        <div class="col-4">
                            <input type="date" class="form-control form-control-sm" name="expiry_date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm mt-2">
                        <i class="fas fa-plus me-1"></i>Add Stock
                    </button>
                </form>

                <!-- Current Stock -->
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Qty</th>
                                <th>Expiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stock %}
                            <tr class="{% if item.quantity < 10 %}table-warning{% endif %}">
                                <td>{{ item.medicine_name }}</td>
                                <td>
                                    <span class="badge {% if item.quantity < 10 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                        {{ item.quantity }}
                                    </span>
                                </td>
                                <td><small>{{ item.expiry_date.strftime('%d/%m/%Y') if item.expiry_date else 'N/A' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not stock %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p><small>No stock available</small></p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reservations -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bookmark me-2"></i>Medicine Reservations</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Medicine</th>
                                <th>Reserved Qty</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>{{ reservation.patient_name }}</td>
                                <td>{{ reservation.medicine_name }}</td>
                                <td>{{ reservation.quantity }}</td>
                                <td>{{ reservation.created_date.strftime('%d/%m/%Y') if reservation.created_date else 'N/A' }}</td>
                                <td>
                                    <span class="badge {% if reservation.status == 'Active' %}bg-primary{% else %}bg-success{% endif %}">
                                        {{ reservation.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if reservation.status == 'Active' %}
                                    <button class="btn btn-success btn-sm"
                                            onclick="markAsCollected({{ reservation.id }})">
                                        <i class="fas fa-check me-1"></i>Mark Collected
                                    </button>
                                    {% else %}
                                    <small class="text-muted">Completed</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not reservations %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bookmark fa-3x mb-3"></i>
                        <p>No reservations</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h5>{{ pending_prescriptions|length }}</h5>
                <small class="text-muted">Pending Prescriptions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                <h5>{{ stock|length }}</h5>
                <small class="text-muted">Items in Stock</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-bookmark fa-2x text-success mb-2"></i>
                <h5>{{ reservations|length }}</h5>
                <small class="text-muted">Active Reservations</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-database fa-2x text-info mb-2"></i>
                <h5>Live</h5>
                <small class="text-muted">Database Connected</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function markAsCollected(reservationId) {
    if (confirm('Mark this reservation as collected?')) {
        // This would make an AJAX call to update the reservation in the database
        fetch('/mark_reservation_collected', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({id: reservationId})
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error updating reservation');
            }
        });
    }
}

$(document).ready(function() {
    // Highlight low stock items
    $('tr.table-warning').each(function() {
        $(this).find('td:first').prepend('<i class="fas fa-exclamation-triangle text-warning me-2"></i>');
    });
});
</script>
{% endblock %}
