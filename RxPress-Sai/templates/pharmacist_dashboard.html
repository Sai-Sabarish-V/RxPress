{% extends "base.html" %}

{% block title %}Pharmacist Dashboard - RxPress{% endblock %}

{% block content %}
<div class="row">
    <!-- Pending Prescriptions -->
                <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Pending Prescriptions</h3>
                        <div class="alert alert-info">
                            <strong>Database Status:</strong> 
                            {% if database_status == "connected" %}
                                <span class="text-success">‚úÖ Connected - Showing real prescriptions from doctors</span>
                            {% elif database_status == "bypassed" %}
                                <span class="text-warning">‚ö° Database bypassed - Showing realistic demo data</span>
                                <br>
                                <small>This shows what your prescriptions would look like once database connectivity is restored</small>
                            {% elif database_status == "timeout" %}
                                <span class="text-warning">‚è∞ Database connection timed out - Showing demo data</span>
                                <br>
                                <small>Your DigitalOcean database may be slow or unreachable</small>
                            {% elif database_status == "failed" %}
                                <span class="text-danger">‚ùå Database connection failed - Showing demo data</span>
                                <br>
                                <small>Check your DigitalOcean database credentials and network</small>
                            {% elif database_status == "demo" %}
                                <span class="text-info">üìù Using demo data - Database connection issue</span>
                            {% else %}
                                <span class="text-info">üîÑ Checking database connection...</span>
                            {% endif %}
                        </div>
                    </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Medicines</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prescription in pending_prescriptions %}
                            <tr>
                                <td>{{ prescription.patient_name }}</td>
                                <td><small>{{ prescription.doctor_name }}</small></td>
                                <td>
                                    <small>{{ prescription.medicines[:30] if prescription.medicines else 'No medicines' }}{% if prescription.medicines and prescription.medicines|length > 30 %}...{% endif %}</small>
                                    {% if prescription.medicines_out_of_stock is defined and prescription.medicines_out_of_stock %}
                                    <br><small class="text-danger">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        Out of stock: {{ prescription.medicines_out_of_stock|join(', ') }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td><small>{{ prescription.created_date[:10] if prescription.created_date else 'N/A' }}</small></td>
                                <td>
                                    {% if prescription.medicines and prescription.all_in_stock is defined and prescription.all_in_stock %}
                                    <button class="btn btn-success btn-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#dispenseModal" 
                                            data-presc-id="{{ prescription.id or '' }}"
                                            onclick="setPrescriptionId('{{ prescription.id or '' }}')">
                                        <i class="fas fa-check"></i> Dispense
                                    </button>
                                    {% elif not prescription.medicines %}
                                    <button class="btn btn-warning btn-sm" disabled title="No medicines prescribed">
                                        <i class="fas fa-exclamation"></i> No Medicines
                                    </button>
                                    {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled title="Some medicines are out of stock">
                                        <i class="fas fa-times"></i> Out of Stock
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not pending_prescriptions %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No pending prescriptions with medicines in stock</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Management -->
    {% if has_medicines %}
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Stock Management</h5>
            </div>
            <div class="card-body">
                <!-- Add/Update Stock Form -->
                <form method="POST" action="{{ url_for('update_stock') }}" class="mb-3">
                    <div class="row g-2">
                        <div class="col-5">
                            <select class="form-select form-select-sm" name="medicine_id" required>
                                <option value="">Select Medicine</option>
                                {% for medicine in medicines %}
                                <option value="{{ medicine.id }}">{{ medicine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control form-control-sm" name="quantity"
                                   placeholder="Qty" min="1" required>
                        </div>
                        <div class="col-4">
                            <input type="date" class="form-control form-control-sm" name="expiry_date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm mt-2">
                        <i class="fas fa-plus me-1"></i>Add Stock
                    </button>
                </form>

                <!-- Current Stock -->
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Qty</th>
                                <th>Expiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stock %}
                            <tr class="{% if item.quantity < 10 %}table-warning{% endif %}">
                                <td>{{ item.medicine_name }}</td>
                                <td>
                                    <span class="badge {% if item.quantity < 10 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                        {{ item.quantity }}
                                    </span>
                                </td>
                                <td><small>{{ item.expiry_date[:10] if item.expiry_date else 'N/A' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not stock %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p><small>No stock available</small></p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Stock Management</h5>
            </div>
            <div class="card-body">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-pills fa-3x mb-3"></i>
                    <p>No medicines available in database</p>
                    <small>Add medicines to the database to manage stock</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Reservations -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bookmark me-2"></i>Medicine Reservations</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Medicine</th>
                                <th>Reserved Qty</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>{{ reservation.patient_name }}</td>
                                <td>{{ reservation.medicine_name }}</td>
                                <td>{{ reservation.quantity }}</td>
                                <td>{{ reservation.created_date[:10] if reservation.created_date else 'N/A' }}</td>
                                <td>
                                    <span class="badge {% if reservation.status == 'Active' %}bg-primary{% else %}bg-success{% endif %}">
                                        {{ reservation.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if reservation.status == 'Active' %}
                                    <button class="btn btn-success btn-sm"
                                            onclick="markAsCollected({{ reservation.id }})">
                                        <i class="fas fa-check me-1"></i>Mark Collected
                                    </button>
                                    {% else %}
                                    <small class="text-muted">Completed</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if not reservations %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bookmark fa-3x mb-3"></i>
                        <p>No reservations</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h5>{{ pending_prescriptions|length }}</h5>
                <small class="text-muted">Pending Prescriptions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                <h5>{{ stock|length }}</h5>
                <small class="text-muted">Items in Stock</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-bookmark fa-2x text-success mb-2"></i>
                <h5>{{ reservations|length }}</h5>
                <small class="text-muted">Active Reservations</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-database fa-2x text-info mb-2"></i>
                <h5>Live</h5>
                <small class="text-muted">Database Connected</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Function to manually set prescription ID (fallback for modal event issues)
function setPrescriptionId(prescId) {
  console.log('setPrescriptionId called with:', prescId);
  if (prescId && prescId.trim() !== '') {
    document.getElementById('dispense_prescription_id').value = prescId.trim();
    window.currentPrescId = prescId.trim();
    console.log('Prescription ID set to:', prescId.trim());
  } else {
    console.error('Invalid prescription ID provided:', prescId);
  }
}

// Bind prescription id into modal when opened
var dispenseModal = document.getElementById('dispenseModal');
if (dispenseModal) {
  dispenseModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var prescId = button.getAttribute('data-presc-id');
    console.log('Modal opened, button:', button, 'prescId from data-presc-id:', prescId);
    
    // Ensure prescription ID is properly set
    if (prescId && prescId.trim() !== '') {
      document.getElementById('dispense_prescription_id').value = prescId.trim();
      window.currentPrescId = prescId.trim();
    } else {
      console.error('No prescription ID found on button element');
      document.getElementById('dispense_prescription_id').value = '';
      window.currentPrescId = '';
    }
    
    document.getElementById('otp_input').value = '';
    document.getElementById('otp_status').innerText = '';
  });
}

// Submit dispense form via fetch
function submitDispenseForm(e){
  e.preventDefault();
  const form = document.getElementById('dispenseForm');
  const fd = new FormData(form);
  fetch('/dispense', { method: 'POST', body: fd }).then(async (res) => {
    const data = await res.json();
    if (res.ok && data.success){
      location.reload();
    } else {
      alert(data.message || 'Error');
    }
  }).catch(() => alert('Network error'));
}

// Send OTP for this prescription's patient and show it inline (demo)
function sendOtpForPrescription(){
  let prescId = document.getElementById('dispense_prescription_id').value;
  console.log('Send OTP clicked, hidden input value:', prescId);
  
  // Try multiple fallback methods to get prescription ID
  if (!prescId || prescId.trim() === ''){
    prescId = (window.currentPrescId || '').toString();
    console.log('Using fallback prescId from global var:', prescId);
  }
  
  // Last resort: try to find the currently open modal's trigger button
  if (!prescId || prescId.trim() === ''){
    const activeModal = document.querySelector('.modal.show');
    if (activeModal) {
      // Look for the button that opened this modal (this is a bit hacky but should work)
      const buttons = document.querySelectorAll('button[data-bs-target="#dispenseModal"]');
      for (let btn of buttons) {
        const btnPrescId = btn.getAttribute('data-presc-id');
        if (btnPrescId && btnPrescId.trim() !== '') {
          prescId = btnPrescId.trim();
          console.log('Found prescription ID from button scan:', prescId);
          // Update the hidden input and global var for future use
          document.getElementById('dispense_prescription_id').value = prescId;
          window.currentPrescId = prescId;
          break;
        }
      }
    }
  }
  
  if (!prescId || prescId.trim() === ''){
    document.getElementById('otp_status').innerText = 'Could not determine prescription id. Debug: hidden=' + document.getElementById('dispense_prescription_id').value + ', global=' + window.currentPrescId + '. Please close and reopen the modal.';
    console.error('No prescription ID available after all fallback attempts.');
    return;
  }
  
  const btn = document.getElementById('btn_send_otp');
  btn.disabled = true;
  document.getElementById('otp_status').innerText = 'Sending OTP for prescription ' + prescId + '...';
  
  const fd = new FormData();
  fd.append('prescription_id', prescId.trim());
  
  fetch('/prescription/send_patient_otp', {method:'POST', body: fd})
    .then(async (res)=>{
      const data = await res.json();
      if (res.ok && data.success){
        document.getElementById('otp_input').value = data.otp || '';
        document.getElementById('otp_status').innerText = data.otp ? ('OTP: ' + data.otp + ' (valid ' + (data.expires_in || '') + 's)') : 'OTP generated.';
      } else {
        document.getElementById('otp_status').innerText = data.message || 'Failed to send OTP.';
      }
    })
    .catch((error)=>{
      console.error('Error sending OTP:', error);
      document.getElementById('otp_status').innerText = 'Network error sending OTP.';
    })
    .finally(()=>{
      btn.disabled = false;
    });
}

$(document).ready(function() {
    // Highlight low stock items
    $('tr.table-warning').each(function() {
        $(this).find('td:first').prepend('<i class="fas fa-exclamation-triangle text-warning me-2"></i>');
    });
    
    // Verify modal elements exist
    console.log('DOM ready - checking modal elements:');
    console.log('dispenseModal exists:', !!document.getElementById('dispenseModal'));
    console.log('dispense_prescription_id exists:', !!document.getElementById('dispense_prescription_id'));
    console.log('btn_send_otp exists:', !!document.getElementById('btn_send_otp'));
    console.log('otp_status exists:', !!document.getElementById('otp_status'));
});
</script>

<!-- Dispense Modal -->
<div class="modal fade" id="dispenseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dispense Prescription</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="dispenseForm" onsubmit="submitDispenseForm(event)">
          <input type="hidden" id="dispense_prescription_id" name="prescription_id" />
          <div class="mb-2">
            <button id="btn_send_otp" type="button" class="btn btn-outline-primary btn-sm" onclick="sendOtpForPrescription()">
              Send OTP
            </button>
            <small id="otp_status" class="text-muted ms-2"></small>
          </div>
          <div class="mb-3">
            <label class="form-label">OTP</label>
            <input id="otp_input" type="text" class="form-control" name="otp" maxlength="6" pattern="\d{6}" placeholder="6-digit OTP" required />
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-success"><i class="fas fa-check me-1"></i>Verify & Dispense</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
